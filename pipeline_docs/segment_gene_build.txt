==========================================
Predicting TcR/Ig gene segments in Ensembl
==========================================

The "classical" Ensembl gene-build performs badly in genomic regions
containing clusters of Immunoglobulin/T-cell repeptor gene
segments. This is because many proteins in Uniprot are full-length
products of a transcript expressed from the genome after the associated 
V(D)J recombination event. When aligned back to the genome using a
spliced-alignment program (e.g. Genewise, Exonerate), the segment
boundaries are often incorrectly predicted because the junctions have a
very different sequence signal to that of splice sites. In addition,
the C and V segments are often mult-exon, making delineation of the
predicted "transcript" into V/D/J/C segments non trival. 

To overcome this problem, we make use of the IMGT database
(http://imgt.cines.fr/) which contains annotations of individual gene
segments on RNA and genomic DNA reference entries. Our strategy then
is extract the segments for our species of interest from IMGT and
align those to the genome (using Exonerate). The gene segments are
then transferred into a database that contains an existing, standard
gene-build, removing transcripts that "interfere" (overlap at the exon
level) with segments (in the assumption that they are wrong).



========
OVERVIEW
========

The procedure can be broken down into the following stages:

(1) Download and preparation of the IMGT database flat file

(2) Extraction of relevant segment sequences from the file file

(3) Alignment of segment sequences to the genome using Exonerate

(4) Run the IgSegBuilder, which uses the Exonerate alignments to
    construct the set of gene segments

(5) Integration of segments into main build.

 The precise mechanics of
    this depend on whether the segments are being supplied as a patch
    for a current, release build, or are available at the time of the
    main build itself. 



============
REQUIREMENTS
============

- Code

  The following CVS check-outs are required (and the path to the
  "modules" directory in each of the check-outs should be added to
  PERL5LIB): 

  ensembl
  ensembl-analysis
  ensembl-pipeline
  ensembl-personal/klh/imgt

  As normal, bioperl is also required. For the extraction of sequence
  segments from the IMGT flat-file, it is necessary to use a recent
  version of bioperl (1.5+). Also, you might find ensembl-config
  useful as it contains exonerate settings for the March 2006 human
  and mouse builds.


- Databases

  (1) A pipeline database. This database should contain the sequence
      and assembly of the genome of interest, and will store the
      results of the Exonerate alignments. 

  (2) An output database. This will be the the database into which
      the gene-segments are written by the IgSegBuilder stage. 

  (3) A release database (optional). If providing the gene segments as
      a patch for an existing build, this database will contain the
      genes, features and all other data from that build (and is the
      database that will be patched and handed over).  

- Data

  (1) The IMGT database flat-file. 

  (2) A list of entries to ignore ("kill list") when extracting
      sub-sequences from the IMGT flat-file. The latest list can be
      found in ensembl-personal/klh/imgt/data/kill_list.txt


======================================================
STEP 1: Download and preparation of the IMGT flat file
======================================================
        
The database distribution can be obtained from:

    ftp://ftp.cines.fr/IMGT/IMGT.zip
    
After unzipping, the flat-file is IMGT/imgt.dat.Z, which should be
moved into another directory and uncompressed (don't be fooled by the
apparently already-uncompressed imgt-dat; this is a small file and
seems to be an artefact). 
    
Some of the downstream processes require the flat-file to be indicate
indexed, which can be peformed thus: 

 ~searle/progs/production_code/ensembl-trunk_1106/ensc-core/src/Programs/indicate --data_dir $WORK/ig/IMGT/database -f imgt.dat -i $WORK/ig/IMGT/database/indicate_idx -l ID -r ID -p emblParser


======================================================
STEP 2: Extraction of relevant segments from flat-file
======================================================

ensembl-personal/klh/imgt/scripts contains two scripts to help with
this task. The first, extract_segments_from_imgt.pl, fetches
segments with the specified tag or tags from the flat file. The
second, contant_regions_from_imgt.pl, extracts constant regions from
genomic DNA entries the flat file. A specialist script is needed to do
this, because the constant regions can contain multiple exons and also
UTR which needs to be removed. 

Examples:

perl extract_segments_from_imgt.pl -tag L-PART1:L-PART2:V-REGION -tag L-REGION:V-REGION -tag L-V-REGION -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 30 -Cstopallow 2 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat

This example extracts human V segments from the file (including the
leader sequence). The following points are of note:

- LV regions are flagged in different ways in different entries. Three
  different variants of the "-tag" option are therefore supplied.

- Rejection of entries with the keywords "orphon", "Ig-surrogate" and
  "Ig-surrogate-vpreb" because these refer to sequences that are not
  part of the core Ig/TcR gene segment set.

- We restrict ourselves to entries that have been processed by the
  IMGT team, either manually or automatically (i.e. we do not consider
  the "keyword" annotation class).

- We translate the sequences, resulting in a set of peptides to
  represent the segments. 

- We allow stop codons within 2 residues of the C-terminus of the
  protein, which can sometimes happen in functional V segments (the 3'
  end can be edited away by the recombination event, so these segments
  are stop-free and functional in some recombinations). 

- We reject entries that are found in a "kill list" file (ones that
  we know to be wrong or misleading to the build process). 

perl extract_segments_from_imgt.pl -tag C-REGION -tax Homo_sapiens -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat

perl constant_regions_from_imgt.pl -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -translate -minlength 150 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat

These two examples extract human C segments from the file, using both
the generic script and the constant-region-specific script. 

perl extract_segments_from_imgt.pl -tag D-REGION -tax Homo_sapiens -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -mol genomic_DNA -mol DNA -keyword germline_configuration -flank 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat

This example extracts human D segments from the file. Since D segments
are very short, we restrict to genomic DNA entries and extract 50 bps
of flanking sequence which will make the placement on the genome more
specific. The position of the D-segment itself within the extracted
sequence is stored in the header line. This information can be
extracted into a file to be used as "annotation" for the cdna2genome
model in Exonerate, thus (if the output of th above is D.fa):

perl -ne '/\>(\S+)\s+.+cds=(\d+)\-(\d+)/ and print "$1 + $2 ", $3-$2+1, "\n";' D.fa > D.annotation

The command-lines to prepare the file necessary for Ig segment
annotation in human and mouse are found at the end of this document. 



====================================================================
STEP 3: Alignment of segment sequences to the genome using Exonerate
====================================================================
 
We use Exonerate to align the segment sequences to the genome. The
model used mostly is the standard protein2genome, but we also subvert
the use of the new cdna2genome model to short align D/J segments with
flanking sequence, the reported CDS of the prediction corresponding to
the segment itself. 

 
Some exonerate parameters used:

--bestn

In the main, exonerate is run using --bestn 1, so that only the best
alignment for each query sequence is reported. However, there are some
cases where the correct alignment is not the best scoring one; this is
apparent in the mouse TcR Beta locus for example, which contains a
duplication. For this reason, we sometimes use --bestn > 1 (say 5),
and then use a custom filter,
Bio::EnsEMBL::Analysis::Tools::IgTranscriptFilter, to choose the best
alignment (or alignments) for each query. 


--maxintron

The introns of the segments are small, so to give exonerate a better
chance to find the correct alignment we explicitly set limits: 0 for
the intronless segments (D and J), 1000 for the single-intron LV
segments, and 5000 for the C segments.


--softmasktarget

This needs to be set to false for the LV alignments, because a small
number of them lie in low-complexity regions. 


--percent

This tells exonerate only to report matches that have score that is
within the given percentage of the best possible score for that
alignment. We use it on the J segment protein alignments in
particular, some of which are too different to the genome to be
aligned accurately (resulting in a "best" alignment to the wrong
place). 


--forcegtag

This is set to true for the human/mouse C segment protein alignment
because all C segments have consensus splice-sites in these
genomes. It may not be appropriate to do this for other (especially
draft) genomes. 


--score

For some very small queries (e.g. some J segment protein queries), the
score of the correct alignment is below the default minimum score
cutoff; we therefore explicitly set the score cutoff to zero for these
types. 


The precise settings used for the first human and mouse builds can be
found in ensembl-config,
human/NCBI36_ig/Bio/EnsEMBL/Analysis/Config/Exonerate2Genes.pm, and
mouse/NCBIM36_ig/Bio/EnsEMBL/Analysis/Config/Exonerate2Genes.pm.


======================================================
STEP 4: Run the IgSegBuilder
======================================================

The IgSegBuilder RunnableDB takes the raw transcript-models produced
by exonerate and does the following

(a) Clusters transcripts into gene

(b) Prunes redundant transcripts

(c) Adjusts transcript boundaries so that they begin/end with the
expected sequence motif (a splice site or a recombination signal
sequence). 

(d) Removes "dubious" genes (e.g. short D/J segments that are not
located anywhere near any C/LV segments). 

The result is a set of final, Ig/TcR gene segments. 

The module works on slice input ids, and can cope with whole
chromomes. Since it is likely that only a small number of top-level
sequences will contain raw exonerate alignments, it is more efficient
to make input ids for these slices only; having an input id for each
toplevel sequence will ensure that the whole genome is analysed but
the vast majority of jobs will do nothing. 

Config
------

Configuration for the module is defined in
Bio/EnsEMBL/Analysis/Config/GeneBuild/IgSegmentBuilder.pm. The
variables are as follows:

TRANDB_DATABASES_NAME - the name of the database (in
Config/GeneBuild/Databases.pm) that contains the raw exonerate
transcript models. 

OUTPUTDB_DATABASES_NAME - the name of the database (in
Config/GeneBuild/Databases.pm) to which the result genes will be
written. 

{LV|C|D_J}_LOGICS - defines which logic names in
the exonerate database correspond to each of the four different
segment types. These are lists, so transcripts produced in several
different ways (with correspondingly different analyses) can be used
together to for the final set of C gene segments (for example). 

{LV|C|D|J}_OUTPUT_BIOTYPE - the biotype that will be attached to the
result genes and transcripts in the output database

SUPPORTING_FEATURE_OUTPUT_LOGIC - if the supporting features for the
results transcripts/exons are to be attached to a different analysis
to that of the genes/transcripts themselves, specify the logic name of
that analysis here. 

D_J_PROXIMITY_THRESHOLD - D/J gene segments are are not within the
given distance of a C/LV segment are rejected.



======================================================
STEP 5: Integration of segments into main build
======================================================






=================================================
APPENDIX A: preparation of IMGT segment sequences
 for human and mouse
=================================================

Rules when extracting data from IMGT flat-file

Encoded in the script:

- Ignore pseudogenes (by scanning keywords and looking for the /pseudo tag)

- Ignore partial segments


Specified by command-line options:

- Ignore entries annotated as "orphon" because these will
  map to non-standard-locus positions on the genome and will
  therefore be misleading. 

- Ignore entries with the "Ig-surrogate" keyword, because these
  are Ig "helper" proteins and not segments (also added
  Ig-surrogate-vpreb to the bad keywords list because some of these
  do not also have the "Ig-surrogate" keyword)

- Only process entries of the "by annotator" and "automatic" class
  (thus ignoring the "keyword" class, which have only been
  keyword annotated)

Human
-----

perl extract_segments_from_imgt.pl -tag L-PART1:L-PART2:V-REGION -tag L-REGION:V-REGION -tag L-V-REGION -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 30 -Cstopallow 2 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > L_V.human.pep.fa

perl extract_segments_from_imgt.pl -tag D-REGION -tax Homo_sapiens -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -mol genomic_DNA -mol DNA -keyword germline_configuration -flank 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt $WORK/ig/IMGT/database/imgt.dat > D.human.cdna.fa

perl extract_segments_from_imgt.pl -tag J-REGION -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -minlength 10 -translate -Nstopallow 2 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > J.human.pep.fa

perl extract_segments_from_imgt.pl -tag J-REGION -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -mol genomic_DNA -mol DNA -keyword germline_configuration -flank 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > J.human.cdna.fa

perl extract_segments_from_imgt.pl -tag C-REGION -tax Homo_sapiens -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > C.from_RNA.human.pep.fa

perl constant_regions_from_imgt.pl -tax Homo_sapiens -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -translate -minlength 150 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > C.from_gen_DNA.human.pep.fa

perl -ne '/\>(\S+)\s+.+cds=(\d+)\-(\d+)/ and print "$1 + $2 ", $3-$2+1, "\n";' J.human.cdna.fa > J.human.cdna.annotation

perl -ne '/\>(\S+)\s+.+cds=(\d+)\-(\d+)/ and print "$1 + $2 ", $3-$2+1, "\n";' D.human.cdna.fa > D.human.cdna.annotation

Mouse
-----

perl extract_segments_from_imgt.pl -tag L-PART1:L-PART2:V-REGION -tag L-REGION:V-REGION -tag L-V-REGION -tag V-REGION -tax Mus_musculus -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 30 -Cstopallow 2  -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > L_V.mouse.pep.fa

perl extract_segments_from_imgt.pl -tag D-REGION -tax Mus_musculus -rejectkeyword orphon  -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -mol genomic_DNA -mol DNA -keyword germline_configuration -flank 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > D.mouse.cdna.fa

perl extract_segments_from_imgt.pl -tag J-REGION -tax Mus_musculus -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -minlength 10 -translate -Nstopallow 2 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > J.mouse.pep.fa 

perl extract_segments_from_imgt.pl -tag J-REGION -tax Mus_musculus -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -mol genomic_DNA -mol DNA -keyword germline_configuration -flank 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > J.mouse.cdna.fa

perl extract_segments_from_imgt.pl -tag C-REGION -tax Mus_musculus -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -class automatic -class by_annotators -translate -minlength 50 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > C.from_RNA.mouse.pep.fa

perl constant_regions_from_imgt.pl -tax Mus_musculus -rejectkeyword orphon -rejectkeyword Ig-surrogate -rejectkeyword Ig-surrogate-vpreb -translate -minlength 150 -kill ensembl-personal/klh/imgt/data/kill_list.txt imgt.dat > C.from_gen_DNA.mouse.pep.fa

perl -ne '/\>(\S+)\s+.+cds=(\d+)\-(\d+)/ and print "$1 + $2 ", $3-$2+1, "\n";' J.mouse.cdna.fa > J.mouse.cdna.annotation

perl -ne '/\>(\S+)\s+.+cds=(\d+)\-(\d+)/ and print "$1 + $2 ", $3-$2+1, "\n";' D.mouse.cdna.fa > D.mouse.cdna.annotation



