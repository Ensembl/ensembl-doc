// $Id$

This document describes what you need in order to map genes in an
Ensembl database to other data sets e.g. refseq or swissprot.

All references to pmatch are obsolete.  We're using exonerate
now.


What you need
=============

    * a mysql_instance

    * Bioperl-072
    * Ensembl core
    * ( rd-utils for the pmatch binary )   [pmatch isn't used anymore]

    Those are all available from CVS on the web

    * An Ensembl database containing genes

You will also need the data files to do the mapping what you
need here very much depends on what you have, which species you
want to run on etc.


What to do
==========

NB: In this mapping process the query are the known proteins
(e.g. proteins from swissprot) and target correspond to Ensembl
transcript translation.

First of all you need to set up your configuration.

All of the configuration lies in

    ensembl/misc-scripts/protein_match/mapping_conf.pl.example

This first contains a set of general options.

    * known_min_idt (query idt)
    * ensembl_min_idt (target idt)
        This is the min of exact match (in %) allowed for the
        query sequence and the target sequence.

    * statistic_file
        This is where the get_stats.pl script would write its
        statistics if run query, the location of the file
        containing the dumped peptides from the database.

    * total_sptr
        Location of swall file in sp format which can be greped
        for entries specific to your organism.

    * sptr_fa
        This should be a path to a FastA file which contains
        entries for all the sptr protein you wish to map.

    * sptr_swiss
        This should contain the same entries as the FastA file
        but in sp format so information about links to embl_ids
        and other databases can be parsed out.

    * total_known_fa
        A FastA file of all the proteins you which to pmatch
        against your genes, for human this would contain all
        human sptr and refseq sequences.

    * x_map_out
        This should be a path to a location where the
        get_Xmapping.pl script writes its results to.  This
        shouldn't already exist if it does it will get written
        over.

    * mapping_out
        This is where the output from the pmatch.pl script is
        written.

    * refseq_fa
        Location of the refseq entries in FastA format.

    * refseq_gnp
        Location of the refseq entries in genbank format.

        These (refseq_fa and refseq_gnp) are optional (only if
        refseq is available for the given organism).


There are then a series of species specific settings which very
much depend on which species you are doing mapping for.  If you
are annotating a species which we currently don't you may need
to add new settings here for any questions about these settings
please address then to ensembl-dev.


Database settings
-----------------

    * db
        Name of database.

    * host
        The host that hosts the database.

    * port
        The port to use to access the database on the host.

    * dbuser
        Database username.

    * password
        The password for the database user on the specified
        host.


Executable location
-------------------

    * pmatch
        Location of pmatch executable (obsolete).

    * exonerate
        Location of exonerate executable (optional).  If
        unspecified, the latest stable version will be used.


Organism related information
----------------------------

    * organism
        A name for your organism which the scripts can then use
        to if it needs to do organism specific stuff.

    * ox
        This should be the taxonomy_id for your organism.


And then...
-----------

You then need to load the external db table.  The information
about this can be found here:

    ensembl/misc-scripts/external_db

The external_db.txt contains all of the current entries.  If you
have new xrefs to add you need to add them to this file.  The
file can be loaded into the database using SQL like this:

    load data infile 'path/to/external_db.txt' into table external_db

NB: If you are dealing with a new organism, you should integrate
it in the organism_list option.


What you need to run
====================

All these scripts are present in the
ensembl/misc-scripts/protein_match directory.

You first need to get the specific files for your organism.  The
files which are needed for all mapping are the swissprot files.
These can be got from here:

    ftp://ftp.ebi.ac.uk/pub/databases/SPproteomes/swissprot_files/proteomes/

... for the sp format files and

    ftp://ftp.ebi.ac.uk/pub/databases/SPproteomes/fasta_files/proteomes/

... for the fasta files.

The files are named by taxonomy id so 9606 files are human and
10090 are mouse.  This taxonomy id is only used if you want to
grep SPTR entry from a file containing all organisms.  If you
have already the SPTR file specific to the organism, you don't
need to fill it in.

Alternatively you can the seq files by greping though a complete
file of swall in sp format using the grep_sptr_entries.pl
script.

Some organisms also have refseq files these can be retrieved
from the NCBI ftp site.

Once the configuration has been filled in and all the
prerequisite files are present you first need to run the
get_Xmapping.pl script.

    perl get_Xmapping.pl

This paragraph is obsolete since we moved from pmatch to
exonerate:
    { The you run pmatch.pl this will pmatch the transcript    }
    { peptides against the created peptide set form sptr and   }
    { any other sequences you want the sequences to be mapped  }
    { to (ie every main id you have en try for in the output   }
    { from get_Xmapping.pl) the output will be written to      }
    { whatever location you have in mapping_conf.pl (this      }
    { currently requires a specific version of pmatch which    }
    { puts extra fields in the output, if you need a copy      }
    { of this version mail mongin@ebi.ac.uk we should be       }
    { change to use scanwisepep (from the wise2package soon    }
    { (03/04/03)))                                             }

pmatch.pl is now obsolete (if you still want to use this
mapping procedure, you can as before but to load the data use
old_maps2db.pl).

Instead, use the following command:

    perl exonerate_wrapper.pl -d

    perl maps2db.pl

Finally you run load_transcript_display_id.pl this puts entries
in the display_xref_id of the gene and transcript columns which
id they use for a particular gene is specified by the priorities
defined at the top of the script. If you have created a new
external_db table entry (is from using a new data source) you
will need to decide whether those ids should be used before or
after any other existing ids and set their priority accordingly.

    perl load_transcript_display_id.pl

As a note for elegans you don't need to do all this as wormbase
provide a file containing all this mapping already.

    ftp://ftp.sanger.ac.uk/pub/databases/wormpep/wormpep.table

This means the only script you should need to run is

    load_elegans_CE.pl

For more information where to get the file needed, links or
email contacts are provided in the mapping_conf.pl file.
