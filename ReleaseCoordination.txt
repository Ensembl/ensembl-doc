Ensembl Release Coordination
============================

This document is mainly for internal production purposes.

Deadlines Summary
=================

The deadlines are counted backwards from the release date so that every phase
has a consistent amount of time each month.  The declaration of intentions is 
the expception and is always on the 1st of the month.

DECLARATION OF INTENTIONS
1st - declaration of intentions

3 Days before GeneBuild handover (pseudo-deadline) 
By this time core dbs should be ready for stable ID mapping and
peptide dumps

GENEBUILD HANDOVER to Core/Compara
10 Working days before Core handover  
  core-like dbs, snp, vega should be ready to copy over ecs2d
  ready meaning, gene_build complete
  stable_id and id-mapping done
  protein annotation and mapping done

CORE/COMPARA HANDOVER to Mart/Webteam
5 Working days before Mart handover,

MART HANDOVER to Webteam
2 Working days before release 

RELEASE 
1st of the next month or the following Monday if the 1st is on a Friday, 
Saturday, or Sunday (webteam do not release on Fridays).
    
Note that there is a script at ensembl-doc/calc_release_deadlines.pl which
will generate the dates for you, given the release date (--release
argument). It should take account of weekends and Bank Holidays.

Database naming convention
==========================

The schema version number changes if there are any core or compara
schema changes, or if there are any significant API changes.  
The assembly version number changes if there is a new
assembly (or has a letter appended if there is a patch or some other
change).

Main steps in release coordination
==================================

* A - on the 1st of the month previous to release send a mail with
  subject like "December release: declaration of intention", asking people
  to declare what are the new databases and schema changes expected.
  Give people a couple of days to declare, send a reminder then with a 
  summary of what has been declared. Also announce new version number if it's
  changed.

* A1 - check how old is the ensembl_go_* database, and if it is older than
  6 months ask Tony Cox (avc@sanger.ac.uk) to generate an updated version.
  Check how old is homo_sapiens_disease_* database, ask Arek (arek@ebi.ac.uk)
  if it needs an update in sync with the latest OMIM release.  

* B - Ask the martians to copy from ecs2:3364 over to ecs2:3363 the old dbs. 
  Send an email to ensembl-admin saying which databases you're going 
  to drop, in case there are any objections.
  Drop from ecs2:3364 all the old databases when allowed.
  (use drop database command in a MySQL client, never do a rm -rf as
  mysqlens user). Do not delete databases like ensembl_% and with
  %_expression_% in their name. Check with compara and mart people to see 
  if ensembl_compara_* and ensembl_mart_* can be dropped.

* C - Based on the synthesis of what is new coming, you can decide what are
  the databases that will not change, and can copy their latest version
  from ecs3:3307 using ensembl/scripts/CopyDBoverServer.pl scripts, -h gives
  you an idea how to use it.
  You have to run it as mysqlens user.
  Must be run on the destination host.

* D - keep a tight contact with the persons involved in the production of
  new data, i.e.
  Yuan/Daniel for snp/haplotype,
  Laura/Felix for worm dbs,
  Val/Steve for mammalian dbs,
  Martin/Vivek/Jan for insect dbs,
  Kerstin/Mario for Zebrafish/Xenopus,
  Steve T./Patrick for vega,
  Cara/Jessica/Abel for compara

  Send them a mail from time to time, to see how things are going.

  From time to time ask James Smith to run lite in the corresponding databases.
  In case you want to build lite yourself, you'll need ensembl-lite cvs repository.
  This should disappear with the introduction of the new variation database.

  Note that, currently, if there are new SNPs, the following needs to be done
  *in this order*:

    - rebuild SNP database
    - generate lite databases
    - recalculate SNP density features

* D1 - For new genebuilds, various density features and seq_region attributes 
  need to be calculated. To do this the following scripts should be run, all of
  which are in ensembl/misc-scripts/density_feature/ and produce several types
  of density_feature:

    gene_density_calc.pl     (takes about 15 minutes)
    percent_gc_calc.pl       (takes about 12 HOURS)
    repeat_coverage_calc.pl  (takes about 12 HOURS)

  The above three scripts can be run at any time after the database has been 
  received from the genebuilders.

  There are 2 more scripts that need to be run *after* the SNP *and* lite 
  databases have been built:

    snp_lite_density.pl      (takes about XXX, produces SNP density features)
    seq_region_stats.pl      (takes about XXX, produces seq_region_attribs)

* E - On the Genebuild handover date all dbs but compara are expected 
  to be ready and copied over to ecs2:3364.

* F - Set up a web test server on ecs2 node. When done, send a mail
  to ensembl-admin to ask everyone concerned to check the display of
  his/her data on the web.

To set up a web server, it is better to do it as ***REMOVED*** unix user. So that
in case, you are not around and a fix is needed, it can be applied by someone else.

The default port use to be 5000, but you can choose whatever you like, as far
as it is announce in ensembl-admin.

It's customary to create a directory for each release, e.g. for
release 26 use ensembl_26

su ensembl
mkdir /nfs/acari/websites/ensembl_26
cd /nfs/acari/websites/ensembl_26
cvs -d :ext:ensembl@cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co sanger-web
cvs -d :ext:ensembl@cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co ensembl
cvs -d :ext:ensembl@cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co ensembl-external
cvs -d :ext:ensembl@cvs.sanger.ac.uk:/nfs/ensembl/cvsroot co ensembl-compara

get the latest stable bioperl version (see
http://www.bioperl.org/Core/Latest/index.shtml)

setenv http_proxy "http://wwwcache.sanger.ac.uk:3128" (to make wget work)
wget http://bioperl.org/DIST/bioperl-1.2.3.tar.gz
gtar xvzf bioperl-1.2.3.tar.gz
rm -f bioperl-1.2.3.tar.gz
ln -s bioperl-1.2.3 bioperl-live (that is to comply with @INC set up
in conf/httpd.conf file)

mkdir logs (needed for webserver logs)

if /nfs/acari/websites/ensembl_26 already exists, running
a cvs up -dP on each module should be enough (unless a lot of conflicts appears). 
The bioperl version already installed should also work.

Modify some conf files.

cd conf

Files to be modifyied would be 
MULTI.ini
 indicates the name of the multispecies dbs

DEFAULTS.ini
 update the following variables if not already done
 ENSEMBL_HOST            = ecs2
 ENSEMBL_HOST_PORT       = 3364
 ENSEMBL_WRITE_USER      = ***REMOVED***
 ENSEMBL_WRITE_PASS      = xxxx

SiteDefs.pm
 update the following variables if not already done
 $ENSEMBL_PORT           = '5000';
 $ENSEMBL_USER           = ***REMOVED***;
 $ENSEMBL_ERRORS_TO      = 'abel@ebi.ac.uk';

Note if there are new species you'll need to create a new .ini file
and add the relevant entry to the $ENSEMBL_SPECIES_ALIASES hash in
SiteDefs.pm. Also there won't be a static index page for it yet so
you'll need to point people directly at the mapview page e.g.
http://ecs2d:5000/Tetraodon_nigroviridis/mapview

Homo_sapiens.ini
 update the following variables if not already done
 ENSEMBL_GOLDEN_PATH     = NCBI35
 ENSEMBL_DB              = homo_sapiens_core_26_35
 ENSEMBL_DISEASE         = homo_sapiens_disease_26_35
 ENSEMBL_EST             = homo_sapiens_est_26_35
 ENSEMBL_ESTGENE         = homo_sapiens_estgene_26_35
# ENSEMBL_FASTA           = homo_sapiens_fasta_26_35
 ENSEMBL_HAPLOTYPE       = homo_sapiens_haplotype_26_35
 ENSEMBL_LITE            = homo_sapiens_lite_26_35
 ENSEMBL_VEGA            = homo_sapiens_vega_26_35
 ENSEMBL_SNP             = homo_sapiens_snp_26_35

ad so one for species to be served Mus_musculus.ini,
Rattus_norvegicus.ini, etc...

At this stage you can also comment out the ENSEMBL_FASTA lines.

As Mart is not used, the follownig 2 lines in perl.startup script can be commented out
#use MartDefs;
[...]
# MartDefs->new();

Then start the server

./ctrl_scripts/start_server
or ./ctrl_scripts/start_server -r (if you want to delete config.packed)

This will go through all the conf files and create the file
conf/config.packed; this is used to speed up starting the server. If
you change a config file, you will need to delete this file before you
re-start the httpd, so that the changes will be taken into account.

to stop it

./ctrl_scripts/stop_server

* G - Ask the release core assistant to run health check suite and to
  update schema if needed. Advertise any inconsistency in the dbs,
  and fix or arrange someone to fix them. 

* H - Run a healthcheck again just before handover (checking things
  we had done before plus new things that have been added during the data
  shakedown) - if possible of course

* I - By the Core/Compara handover date if everything is fine, send a
  mail to hand-over the dbs, listing all dbs, specifying what are the
  new data coming in, the schema changes.
  Mention there when is the dead line for mart db handover.
  If there have been any schema changes, send the appropriate patch SQL
  file to the web team so that they can publish it.

* J- Even if by this date, the main part of your work is over, you will
  still need to follow mail about dbs problems take some decision
  together with the web team to fix them.

* K- By the day of release, organise a post-mortem meeting to list what
  were the problem during the release, propose/ask for possibles
  solutions/improvements for the next release.
  The main persons to be there should be Jim, James, Arne, Arek, Abel, Val, Steve,
  Glenn, Ewan. I found out that find the right day and time to have
  most of those people together has been the most complicated task. You
  will have to organize that in morning as Val is working part time.

* L- send a email minute to ensembl-admin to summarize what was discussed/decided during
  post-mortem.



